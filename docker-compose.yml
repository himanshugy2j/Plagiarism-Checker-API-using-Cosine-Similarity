version: '3.8'

services:
  # =========================
  #  Flask Backend
  # =========================
  flask:
    build:
      context: .
      dockerfile: flask_api/Dockerfile
    ports:
      - "5000:5000"
    volumes:
      - ./flask_api:/app/flask_api
    environment:
      - FLASK_ENV=development
    networks:
      - kong-net

  # =========================
  #  Streamlit Frontend
  # =========================
  streamlit:
    build:
      context: .
      dockerfile: streamlit_app/Dockerfile
    ports:
      - "8501:8501"
    depends_on:
      - flask
      - kong
    volumes:
      - ./streamlit_app:/app
    networks:
      - kong-net

  # =========================
  #  Kong Database
  # =========================
  kong-database:
    image: postgres:15
    container_name: kong_db
    environment:
      POSTGRES_USER: kong
      POSTGRES_DB: kong
      POSTGRES_PASSWORD: kong
    volumes:
      - kong_data:/var/lib/postgresql/data
    networks:
      - kong-net
    ports:
      - "15432:5432"   # Host port changed to avoid conflict
    restart: unless-stopped

  # =========================
  #  Kong Gateway
  # =========================
  kong:
    image: kong:3.7
    container_name: kong_gateway
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong_db
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kong
      KONG_PG_DATABASE: kong
      KONG_PROXY_LISTEN: 0.0.0.0:8000, 0.0.0.0:8443 ssl
      KONG_ADMIN_LISTEN: 0.0.0.0:8001, 0.0.0.0:8444 ssl
    depends_on:
      - kong-database
    ports:
      - "9000:8000"   # Proxy HTTP
      - "9443:8443"   # Proxy HTTPS
      - "9001:8001"   # Admin HTTP
      - "9444:8444"   # Admin HTTPS
    networks:
      - kong-net
    restart: unless-stopped

volumes:
  kong_data:

networks:
  kong-net:
    driver: bridge
